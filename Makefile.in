PROGNAME = amazed
OBJFILES = maze.o curses.o
CXXFLAGS = @CXXFLAGS@
CPPFLAGS = @CPPFLAGS@ @NCURSES_CFLAGS@ @SDL_CFLAGS@ -Iinclude -DPROGNAME="\"$(PROGNAME)\""
TESTFLAGS = @TESTFLAGS@ -lcriterion
LDFLAGS = @LDFLAGS@
LXXFLAGS = @LIBS@
prefix = @prefix@

VPATH = src:include
vpath %.cpp src src/environment src/board src/synth
vpath %.hpp include

.PHONY: all clean install check-style coverage documentation test

LXXFLAGS += @NCURSES_LIBS@ @SDL_LIBS@
# Test if we are building on/for windows or not
ifeq ($(OS),Windows_NT)
else
       	# add pthread support to make <thread> work
	LXXFLAGS += -lpthread
endif

all: $(PROGNAME)
	@mv $< bin/

documentation:
	@doxygen .doxy.cfg

clean:
	@find . -name "*.test" -delete
	@find . -name "*.o" -delete
	@find . -name "*.gc??" -delete
	@find . -name "*.info" -delete
	@find . -name "*.profraw" -delete
	@find bin/ -type f -perm -u=x -delete

love:
	@echo '<3'

friends:
	@echo '^-^'

check-style:
	@ cppcheck --enable=warning,performance,portability --platform=unix64 src/

test: test/maze.cpp $(OBJFILES)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -o bin/test $^ $(LXXFLAGS) $(TESTFLAGS)
	@./bin/test

$(PROGNAME): main.o $(OBJFILES)
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LXXFLAGS)

coverage: test
	./bin/$<
ifneq ($(CXX),g++)
	@echo "Only g++ is supported for coverage generation!"
	@exit 1
endif
	gcov -a -u -b -c src/*
	lcov -c --directory . -o $(PROGNAME).info
	lcov -e $(PROGNAME).info '$(CURDIR)/*' -o $(PROGNAME)_filter.info
	lcov --summary $(PROGNAME)_filter.info
	genhtml $(PROGNAME)_filter.info --output-directory coverage
	gcovr -x -o coverage.xml -r .

%.o: %.cpp %.hpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -o $@ -c $<

test/%.o: test/%.cpp %.hpp
	$(CXX) $(CXXFLAGS) $(CPPFLAGS) -o $@ -c $<
